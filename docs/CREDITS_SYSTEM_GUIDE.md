# ç§¯åˆ†ç³»ç»Ÿå®æ–½æŒ‡å—

## Phase 1: æ ¸å¿ƒåŸºç¡€ âœ… å·²å®Œæˆ

### å·²å®Œæˆçš„å·¥ä½œ

#### 1. æ•°æ®åº“å±‚é¢
- âœ… åœ¨ `schema.js` ä¸­æ·»åŠ äº† 6 å¼ æ–°è¡¨ï¼š
  - `user_credits` - ç”¨æˆ·ç§¯åˆ†è´¦æˆ·è¡¨
  - `credit_transactions` - ç§¯åˆ†äº¤æ˜“è®°å½•è¡¨
  - `post_rewards` - å¸–å­æ‰“èµè®°å½•è¡¨
  - `shop_items` - å•†åŸå•†å“è¡¨
  - `user_items` - ç”¨æˆ·å•†å“æ‹¥æœ‰è¡¨
  - `credit_system_config` - ç§¯åˆ†ç³»ç»Ÿé…ç½®è¡¨
- âœ… æ›´æ–°äº† `users` å’Œ `posts` è¡¨çš„å…³ç³»å®šä¹‰
- âœ… åˆ›å»ºäº†æ•°æ®åº“è¿ç§»æ–‡ä»¶ï¼š`drizzle/0002_credit_system.sql`

#### 2. åç«¯ API
- âœ… åˆ›å»ºäº†ç§¯åˆ†æœåŠ¡æ¨¡å—ï¼š`features/credits/services/creditService.js`
  - è·å–/åˆ›å»ºç”¨æˆ·ç§¯åˆ†è´¦æˆ·
  - å‘æ”¾/æ‰£é™¤ç§¯åˆ†
  - è½¬è´¦ç§¯åˆ†ï¼ˆæ‰“èµï¼‰
  - æ¯æ—¥ç­¾åˆ°é€»è¾‘
  - è·å–äº¤æ˜“è®°å½•
  - è·å–æ’è¡Œæ¦œ
  - é…ç½®ç®¡ç†

- âœ… åˆ›å»ºäº†ç§¯åˆ†è·¯ç”±ï¼š`features/credits/routes/index.js`
  - `GET /api/credits/balance` - è·å–ä½™é¢
  - `POST /api/credits/check-in` - æ¯æ—¥ç­¾åˆ°
  - `GET /api/credits/transactions` - äº¤æ˜“è®°å½•
  - `POST /api/credits/reward` - æ‰“èµå¸–å­
  - `GET /api/credits/rewards/:postId` - è·å–æ‰“èµåˆ—è¡¨
  - `POST /api/credits/rewards/batch` - æ‰¹é‡è·å–æ‰“èµç»Ÿè®¡
  - `GET /api/credits/rank` - ç§¯åˆ†æ’è¡Œæ¦œ
  - ç®¡ç†å‘˜æ¥å£ï¼ˆç»Ÿè®¡ã€å‘æ”¾ã€æ‰£é™¤ã€é…ç½®ç®¡ç†ï¼‰

#### 3. å‰ç«¯é¡µé¢
- âœ… åˆ›å»ºäº†ç§¯åˆ† API å®¢æˆ·ç«¯ï¼š`features/credits/api/index.js`
  - å®Œæ•´çš„ `creditsApi` æ¨¡å—

- âœ… åˆ›å»ºäº†ç§¯åˆ†ä¸­å¿ƒé¡µé¢ï¼š`features/credits/pages/user/UserCreditsPage.jsx`
  - ç§¯åˆ†ä½™é¢å±•ç¤ºï¼ˆå½“å‰/ç´¯è®¡è·å¾—/ç´¯è®¡æ¶ˆè´¹ï¼‰
  - ç­¾åˆ°åŠŸèƒ½ï¼ˆæ˜¾ç¤ºè¿ç»­ç­¾åˆ°å¤©æ•°ï¼‰
  - ç§¯åˆ†äº¤æ˜“è®°å½•åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰
  - è·¯ç”±ï¼š`app/profile/credits/page.js`

- âœ… æ›´æ–°äº†ä¸ªäººä¸­å¿ƒä¾§è¾¹æ 
  - æ·»åŠ äº†"ç§¯åˆ†ä¸­å¿ƒ"èœå•é¡¹

## å¦‚ä½•å¯åŠ¨å’Œæµ‹è¯•

### æ­¥éª¤ 1: è¿è¡Œæ•°æ®åº“è¿ç§»

```bash
cd apps/api

# æ–¹å¼ 1: ä½¿ç”¨ drizzle-kit è‡ªåŠ¨è¿ç§»
npm run db:migrate

# æ–¹å¼ 2: æ‰‹åŠ¨æ‰§è¡Œ SQLï¼ˆå¦‚æœæ–¹å¼1ä¸å·¥ä½œï¼‰
psql -h localhost -U your_username -d your_database -f drizzle/0002_credit_system.sql
```

### æ­¥éª¤ 2: å¯åŠ¨åç«¯æœåŠ¡

```bash
cd apps/api
npm run dev
```

### æ­¥éª¤ 3: å¯åŠ¨å‰ç«¯æœåŠ¡

```bash
cd apps/web
npm run dev
```

### æ­¥éª¤ 4: è®¿é—®ç§¯åˆ†ä¸­å¿ƒ

1. ç™»å½•è®ºå›è´¦æˆ·
2. è®¿é—®ä¸ªäººä¸­å¿ƒï¼š`/profile`
3. ç‚¹å‡»ä¾§è¾¹æ çš„"ç§¯åˆ†ä¸­å¿ƒ"
4. å°è¯•æ¯æ—¥ç­¾åˆ°åŠŸèƒ½

## ç§¯åˆ†ç³»ç»Ÿé…ç½®

ç³»ç»Ÿå·²ç»é¢„è®¾äº†ä»¥ä¸‹é»˜è®¤é…ç½®ï¼ˆåœ¨è¿ç§»è„šæœ¬ä¸­ï¼‰ï¼š

| é…ç½®é¡¹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| `system_enabled` | true | æ˜¯å¦å¯ç”¨ç§¯åˆ†ç³»ç»Ÿ |
| `check_in_base_amount` | 10 | ç­¾åˆ°åŸºç¡€ç§¯åˆ† |
| `check_in_streak_bonus` | 5 | è¿ç»­ç­¾åˆ°é¢å¤–å¥–åŠ±ï¼ˆæ¯å¤©ï¼‰ |
| `post_topic_amount` | 5 | å‘å¸ƒè¯é¢˜å¥–åŠ± |
| `post_reply_amount` | 2 | å‘å¸ƒå›å¤å¥–åŠ± |
| `receive_like_amount` | 1 | è·å¾—ç‚¹èµå¥–åŠ± |
| `reward_min_amount` | 1 | æ‰“èµæœ€å°é‡‘é¢ |
| `reward_max_amount` | 1000 | æ‰“èµæœ€å¤§é‡‘é¢ |
| `invite_reward_amount` | 50 | é‚€è¯·æ–°ç”¨æˆ·å¥–åŠ± |

## API ç«¯ç‚¹è¯´æ˜

### ç”¨æˆ·ç«¯ç‚¹

```
GET    /api/credits/balance           - è·å–ç§¯åˆ†ä½™é¢
POST   /api/credits/check-in          - æ¯æ—¥ç­¾åˆ°
GET    /api/credits/transactions      - æŸ¥è¯¢äº¤æ˜“è®°å½•
POST   /api/credits/reward            - æ‰“èµå¸–å­
GET    /api/credits/rewards/:postId   - è·å–å¸–å­æ‰“èµåˆ—è¡¨
GET    /api/credits/rank              - ç§¯åˆ†æ’è¡Œæ¦œ
```

### ç®¡ç†å‘˜ç«¯ç‚¹

```
GET    /api/credits/admin/stats       - ç§¯åˆ†ç³»ç»Ÿç»Ÿè®¡
POST   /api/credits/admin/grant       - æ‰‹åŠ¨å‘æ”¾ç§¯åˆ†
POST   /api/credits/admin/deduct      - æ‰‹åŠ¨æ‰£é™¤ç§¯åˆ†
GET    /api/credits/admin/config      - è·å–é…ç½®
PUT    /api/credits/admin/config/:key - æ›´æ–°é…ç½®
```

## ä¸‹ä¸€æ­¥å®æ–½è®¡åˆ’

### Phase 2: ç§¯åˆ†æµé€šï¼ˆé¢„è®¡ 1-2å‘¨ï¼‰

#### ä»»åŠ¡æ¸…å•ï¼š
1. åœ¨å‘å¸–æ¥å£ä¸­é›†æˆç§¯åˆ†å¥–åŠ± âœ…
   - æ–‡ä»¶ï¼š`apps/api/src/routes/topics/index.js`
   - å‘å¸ƒè¯é¢˜æ—¶è‡ªåŠ¨å‘æ”¾ç§¯åˆ†

2. åœ¨å›å¤æ¥å£ä¸­é›†æˆç§¯åˆ†å¥–åŠ± âœ…
   - æ–‡ä»¶ï¼š`apps/api/src/routes/posts/index.js`
   - å‘å¸ƒå›å¤æ—¶è‡ªåŠ¨å‘æ”¾ç§¯åˆ†

3. åœ¨ç‚¹èµæ¥å£ä¸­é›†æˆç§¯åˆ†å¥–åŠ± âœ…
   - æ–‡ä»¶ï¼š`apps/api/src/routes/posts/index.js`
   - è·å¾—ç‚¹èµæ—¶è‡ªåŠ¨å‘æ”¾ç§¯åˆ†ç»™è¢«ç‚¹èµè€…

4. åˆ›å»ºæ‰“èµåŠŸèƒ½ UI ç»„ä»¶ âœ…
   - æ‰“èµå¼¹çª—ï¼š`features/credits/components/RewardDialog.jsx`
   - æ‰“èµè®°å½•ï¼š`features/credits/components/RewardListDialog.jsx`
   - åœ¨å¸–å­ä¸­é›†æˆæ‰“èµæŒ‰é’®

5. åˆ›å»ºç§¯åˆ†æ’è¡Œæ¦œé¡µé¢ âœ…
   - è·¯å¾„ï¼š`apps/web/src/app/rank/page.js`
   - å±•ç¤ºç§¯åˆ†æ’åå‰ 50 ç”¨æˆ·

### Phase 3: å•†åŸç³»ç»Ÿï¼ˆé¢„è®¡ 2-3å‘¨ï¼‰

#### ä»»åŠ¡æ¸…å•ï¼š
1. åˆ›å»ºå•†å“ç®¡ç†åå°é¡µé¢
   - è·¯å¾„ï¼š`apps/web/src/app/dashboard/shop/page.js`
   - CRUD æ“ä½œ

2. åˆ›å»ºå•†åŸå‰ç«¯é¡µé¢
   - è·¯å¾„ï¼š`apps/web/src/app/profile/shop/page.js`
   - å•†å“åˆ—è¡¨å’Œè´­ä¹°

3. åˆ›å»ºæˆ‘çš„é“å…·é¡µé¢
   - è·¯å¾„ï¼š`apps/web/src/app/profile/items/page.js`
   - è£…å¤‡/å¸ä¸‹é“å…·

4. å®ç°å¤´åƒæ¡†ç³»ç»Ÿ
   - CSS æ ·å¼åº”ç”¨
   - åŠ¨æ€æ¸²æŸ“

5. å®ç°å‹‹ç« ç³»ç»Ÿ
   - å‹‹ç« å±•ç¤º
   - å¤šå‹‹ç« ç®¡ç†

### Phase 4: ç®¡ç†ä¸ä¼˜åŒ–ï¼ˆé¢„è®¡ 1å‘¨ï¼‰

#### ä»»åŠ¡æ¸…å•ï¼š
1. ç®¡ç†åå°ç§¯åˆ†é…ç½®é¡µé¢
   - åœ¨ç³»ç»Ÿè®¾ç½®ä¸­æ·»åŠ ç§¯åˆ†ç³»ç»Ÿ Tab

2. ç§¯åˆ†ç»Ÿè®¡æŠ¥è¡¨
   - å¯è§†åŒ–å›¾è¡¨
   - æ•°æ®å¯¼å‡º

3. æ€§èƒ½ä¼˜åŒ–
   - Redis ç¼“å­˜ç§¯åˆ†ä½™é¢
   - æ‰¹é‡æ“ä½œä¼˜åŒ–

4. å®‰å…¨åŠ å›º
   - é˜²åˆ·æœºåˆ¶
   - å¼‚å¸¸æ£€æµ‹

## æµ‹è¯•å»ºè®®

### åŠŸèƒ½æµ‹è¯•
1. âœ… æµ‹è¯•ç­¾åˆ°åŠŸèƒ½
   - é¦–æ¬¡ç­¾åˆ°
   - è¿ç»­ç­¾åˆ°
   - é‡å¤ç­¾åˆ°ï¼ˆåº”è¯¥å¤±è´¥ï¼‰

2. âœ… æµ‹è¯•ç§¯åˆ†ä½™é¢æ˜¾ç¤º
   - æŸ¥çœ‹å½“å‰ä½™é¢
   - æŸ¥çœ‹ç´¯è®¡è·å¾—/æ¶ˆè´¹

3. âœ… æµ‹è¯•äº¤æ˜“è®°å½•
   - åˆ†é¡µåŠŸèƒ½
   - äº¤æ˜“ç±»å‹ç­›é€‰

### é›†æˆæµ‹è¯•ï¼ˆPhase 2ï¼‰
1. å‘å¸ƒè¯é¢˜åè‡ªåŠ¨è·å¾—ç§¯åˆ†
2. å‘å¸ƒå›å¤åè‡ªåŠ¨è·å¾—ç§¯åˆ†
3. è·å¾—ç‚¹èµåè‡ªåŠ¨è·å¾—ç§¯åˆ†
4. æ‰“èµåŠŸèƒ½ç«¯åˆ°ç«¯æµ‹è¯•

### æ€§èƒ½æµ‹è¯•ï¼ˆPhase 4ï¼‰
1. å¹¶å‘ç­¾åˆ°æµ‹è¯•
2. å¤§é‡äº¤æ˜“è®°å½•æŸ¥è¯¢
3. ç§¯åˆ†è½¬è´¦å¹¶å‘å®‰å…¨æ€§

## å¸¸è§é—®é¢˜

### Q: å¦‚ä½•æ‰‹åŠ¨ç»™ç”¨æˆ·å‘æ”¾ç§¯åˆ†ï¼Ÿ
A: ä½¿ç”¨ç®¡ç†å‘˜è´¦æˆ·è°ƒç”¨ `/api/credits/admin/grant` æ¥å£

### Q: å¦‚ä½•ä¿®æ”¹ç§¯åˆ†é…ç½®ï¼Ÿ
A: ä½¿ç”¨ç®¡ç†å‘˜è´¦æˆ·è°ƒç”¨ `/api/credits/admin/config/:key` æ¥å£ï¼Œæˆ–ç›´æ¥ä¿®æ”¹æ•°æ®åº“ `credit_system_config` è¡¨

### Q: ç§¯åˆ†ä½™é¢ä¸ä¸€è‡´æ€ä¹ˆåŠï¼Ÿ
A: è¿è¡Œæ•°æ®ä¸€è‡´æ€§æ ¡éªŒè„šæœ¬ï¼ˆéœ€è¦åˆ›å»ºï¼‰ï¼Œæ£€æŸ¥ `balance = totalEarned - totalSpent`

### Q: å¦‚ä½•ç¦ç”¨ç§¯åˆ†ç³»ç»Ÿï¼Ÿ
A: å°†é…ç½®é¡¹ `system_enabled` è®¾ç½®ä¸º `false`

## æ–‡ä»¶ç»“æ„

### åç«¯ç»“æ„ (Feature-based)
```
apps/api/src/
â””â”€â”€ features/
    â””â”€â”€ credits/
        â”œâ”€â”€ schema.js                    âœ… ç§¯åˆ†ç³»ç»Ÿæ•°æ®è¡¨å®šä¹‰
        â”œâ”€â”€ services/
        â”‚   â””â”€â”€ creditService.js         âœ… ç§¯åˆ†ä¸šåŠ¡é€»è¾‘æœåŠ¡
        â””â”€â”€ routes/
            â”œâ”€â”€ index.js                 âœ… ç§¯åˆ†æ ¸å¿ƒè·¯ç”±
            â””â”€â”€ shop.js                  âœ… å•†åŸè·¯ç”±
```

### å‰ç«¯ç»“æ„ (Feature-based)
```
apps/web/src/
â””â”€â”€ features/
    â””â”€â”€ credits/
        â”œâ”€â”€ api/
        â”‚   â””â”€â”€ index.js                 âœ… ç§¯åˆ† API å®¢æˆ·ç«¯
        â”œâ”€â”€ components/
        â”‚   â”œâ”€â”€ RewardDialog.jsx         âœ… æ‰“èµå¼¹çª—
        â”‚   â”œâ”€â”€ RewardListDialog.jsx     âœ… æ‰“èµè®°å½•å¼¹çª—
        â”‚   â”œâ”€â”€ AutoCheckIn.jsx          âœ… è‡ªåŠ¨ç­¾åˆ°ç»„ä»¶
        â”‚   â”œâ”€â”€ admin/                   âœ… ç®¡ç†åå°ç»„ä»¶
        â”‚   â”‚   â”œâ”€â”€ CreditsStats.jsx
        â”‚   â”‚   â”œâ”€â”€ CreditsOperationDialog.jsx
        â”‚   â”‚   â”œâ”€â”€ TransactionTable.jsx
        â”‚   â”‚   â”œâ”€â”€ ShopItemTable.jsx
        â”‚   â”‚   â””â”€â”€ ShopItemFormDialog.jsx
        â”‚   â”œâ”€â”€ user/                    âœ… ç”¨æˆ·ç«¯ç»„ä»¶
        â”‚   â”‚   â”œâ”€â”€ BalanceCard.jsx
        â”‚   â”‚   â”œâ”€â”€ BalanceOverview.jsx
        â”‚   â”‚   â”œâ”€â”€ CheckInStatus.jsx
        â”‚   â”‚   â”œâ”€â”€ TransactionHistory.jsx
        â”‚   â”‚   â”œâ”€â”€ ShopItemCard.jsx
        â”‚   â”‚   â”œâ”€â”€ ShopItemGrid.jsx
        â”‚   â”‚   â”œâ”€â”€ ItemInventoryCard.jsx
        â”‚   â”‚   â”œâ”€â”€ ItemInventoryGrid.jsx
        â”‚   â”‚   â””â”€â”€ PurchaseDialog.jsx
        â”‚   â””â”€â”€ shared/                  âœ… å…±äº«ç»„ä»¶
        â”‚       â”œâ”€â”€ CreditsBadge.jsx
        â”‚       â”œâ”€â”€ TransactionTypeBadge.jsx
        â”‚       â”œâ”€â”€ ItemTypeBadge.jsx
        â”‚       â””â”€â”€ ItemTypeIcon.jsx
        â”œâ”€â”€ hooks/                       âœ… è‡ªå®šä¹‰ Hooks
        â”‚   â”œâ”€â”€ useCreditsBalance.js
        â”‚   â”œâ”€â”€ useCreditsTransactions.js
        â”‚   â”œâ”€â”€ useShopItems.js
        â”‚   â”œâ”€â”€ useUserItems.js
        â”‚   â””â”€â”€ useItemActions.js
        â”œâ”€â”€ pages/                       âœ… é¡µé¢ç»„ä»¶
        â”‚   â”œâ”€â”€ user/
        â”‚   â”‚   â”œâ”€â”€ UserCreditsPage.jsx  (ç”¨äº /profile/credits)
        â”‚   â”‚   â”œâ”€â”€ UserShopPage.jsx     (ç”¨äº /profile/shop)
        â”‚   â”‚   â””â”€â”€ UserItemsPage.jsx    (ç”¨äº /profile/items)
        â”‚   â””â”€â”€ admin/
        â”‚       â”œâ”€â”€ AdminCreditsPage.jsx (ç”¨äº /dashboard/credits)
        â”‚       â””â”€â”€ AdminShopPage.jsx    (ç”¨äº /dashboard/shop)
        â””â”€â”€ utils/                       âœ… å·¥å…·å‡½æ•°
            â”œâ”€â”€ formatters.js
            â””â”€â”€ validators.js
```

### è·¯ç”±é›†æˆ
```
apps/web/src/app/
â”œâ”€â”€ profile/
â”‚   â”œâ”€â”€ credits/
â”‚   â”‚   â””â”€â”€ page.js                  â†’ å¯¼å…¥ UserCreditsPage
â”‚   â”œâ”€â”€ shop/
â”‚   â”‚   â””â”€â”€ page.js                  â†’ å¯¼å…¥ UserShopPage
â”‚   â””â”€â”€ items/
â”‚       â””â”€â”€ page.js                  â†’ å¯¼å…¥ UserItemsPage
â”œâ”€â”€ dashboard/
â”‚   â”œâ”€â”€ credits/
â”‚   â”‚   â””â”€â”€ page.js                  â†’ å¯¼å…¥ AdminCreditsPage
â”‚   â”œâ”€â”€ shop/
â”‚   â”‚   â””â”€â”€ page.js                  â†’ å¯¼å…¥ AdminShopPage
â”‚   â””â”€â”€ settings/
â”‚       â”œâ”€â”€ page.js                  â†’ é›†æˆ CreditSystemSettings
â”‚       â””â”€â”€ components/
â”‚           â””â”€â”€ CreditSystemSettings.jsx
â””â”€â”€ rank/
    â””â”€â”€ page.js                      âœ… ç§¯åˆ†æ’è¡Œæ¦œ
```


## æŠ€æœ¯æ ˆ

- åç«¯ï¼šNode.js + Fastify + Drizzle ORM + PostgreSQL
- å‰ç«¯ï¼šNext.js 14 + React + Tailwind CSS
- æ•°æ®åº“ï¼šPostgreSQL
- ç¼“å­˜ï¼šRedisï¼ˆPhase 4ï¼‰

## è´¡çŒ®è€…

- Phase 1: æ ¸å¿ƒåŸºç¡€ âœ…
- Phase 2: ç§¯åˆ†æµé€š âœ…

## Phase 2 å®Œæˆå†…å®¹ (2024-12-04)

### åç«¯é›†æˆ
1. âœ… **å‘å¸ƒè¯é¢˜è‡ªåŠ¨å¥–åŠ±** - åœ¨ `topics/index.js` ä¸­é›†æˆï¼Œå‘å¸ƒè¯é¢˜åè‡ªåŠ¨è·å¾—5ç§¯åˆ†
2. âœ… **å‘å¸ƒå›å¤è‡ªåŠ¨å¥–åŠ±** - åœ¨ `posts/index.js` ä¸­é›†æˆï¼Œå‘å¸ƒå›å¤åè‡ªåŠ¨è·å¾—2ç§¯åˆ†
3. âœ… **è·å¾—ç‚¹èµè‡ªåŠ¨å¥–åŠ±** - åœ¨ç‚¹èµæ¥å£ä¸­é›†æˆï¼Œè¢«ç‚¹èµè€…è‡ªåŠ¨è·å¾—1ç§¯åˆ†

### å‰ç«¯åŠŸèƒ½
4. âœ… **æ‰“èµå¼¹çª—ç»„ä»¶** (`RewardDialog.jsx`) - æ”¯æŒå¿«é€Ÿé€‰æ‹©å’Œè‡ªå®šä¹‰é‡‘é¢ï¼Œæ˜¾ç¤ºä½™é¢ï¼Œæ”¯æŒç•™è¨€
5. âœ… **æ‰“èµåˆ—è¡¨ç»„ä»¶** (`RewardList.jsx`) - æ˜¾ç¤ºå¸–å­æ”¶åˆ°çš„æ‰€æœ‰æ‰“èµè®°å½•
6. âœ… **æ‰“èµæŒ‰é’®é›†æˆ** - åœ¨ `ReplyItem.js` ä¸­æ·»åŠ æ‰“èµæŒ‰é’®ï¼Œä¸èƒ½æ‰“èµè‡ªå·±
7. âœ… **ç§¯åˆ†æ’è¡Œæ¦œé¡µé¢** (`/rank`) - æ”¯æŒæŒ‰ä½™é¢å’Œç´¯è®¡è·å¾—æ’åºï¼Œå‰ä¸‰åç‰¹æ®Šå±•ç¤º

### åˆ›å»ºçš„æ–‡ä»¶
```
apps/web/src/features/credits/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ RewardDialog.jsx         âœ… æ‰“èµå¼¹çª—
â”‚   â””â”€â”€ RewardListDialog.jsx     âœ… æ‰“èµè®°å½•å¼¹çª—
â””â”€â”€ app/rank/
    â””â”€â”€ page.js                  âœ… æ’è¡Œæ¦œé¡µé¢
```

### ä¿®æ”¹çš„æ–‡ä»¶
```
apps/api/src/routes/
â”œâ”€â”€ topics/index.js              âœ… è¯é¢˜å‘å¸ƒå¥–åŠ±
â””â”€â”€ posts/index.js               âœ… å›å¤å‘å¸ƒå¥–åŠ± + ç‚¹èµå¥–åŠ±

apps/web/src/components/topic/
â”œâ”€â”€ TopicContent.js              âœ… æ·»åŠ æ‰“èµåŠŸèƒ½
â””â”€â”€ ReplyItem.js                 âœ… æ·»åŠ æ‰“èµæŒ‰é’®å’Œå¯¹è¯æ¡†
```

### ç§¯åˆ†è‡ªåŠ¨å‘æ”¾è§„åˆ™
| è¡Œä¸º | å¥–åŠ±ç§¯åˆ† | è§¦å‘æ—¶æœº |
|------|---------|---------|
| å‘å¸ƒè¯é¢˜ | 5 | è¯é¢˜åˆ›å»ºæˆåŠŸä¸”å·²æ‰¹å‡† |
| å‘å¸ƒå›å¤ | 2 | å›å¤åˆ›å»ºæˆåŠŸä¸”å·²æ‰¹å‡† |
| è·å¾—ç‚¹èµ | 1 | è¢«ç‚¹èµæ—¶ç«‹å³å‘æ”¾ç»™ä½œè€… |

### æ‰“èµåŠŸèƒ½ç‰¹æ€§
- âœ… æ”¯æŒå¿«é€Ÿé€‰æ‹©é‡‘é¢ï¼ˆ1, 5, 10, 20, 50, 100ï¼‰
- âœ… æ”¯æŒè‡ªå®šä¹‰é‡‘é¢è¾“å…¥
- âœ… æ˜¾ç¤ºå½“å‰ç§¯åˆ†ä½™é¢
- âœ… ä½™é¢ä¸è¶³æ—¶ç¦ç”¨æŒ‰é’®
- âœ… æ”¯æŒæ‰“èµç•™è¨€ï¼ˆæœ€å¤š200å­—ï¼‰
- âœ… ä¸èƒ½æ‰“èµè‡ªå·±çš„å¸–å­
- âœ… æ‰“èµæˆåŠŸåè‡ªåŠ¨åˆ·æ–°ä½™é¢

### æ’è¡Œæ¦œåŠŸèƒ½ç‰¹æ€§
- âœ… æ”¯æŒä¸¤ç§æ’åæ–¹å¼ï¼ˆå½“å‰ä½™é¢ / ç´¯è®¡è·å¾—ï¼‰
- âœ… æ˜¾ç¤ºå‰50åç”¨æˆ·
- âœ… å‰ä¸‰åç‰¹æ®Šæ ‡è®°ï¼ˆé‡‘é“¶é“œç‰Œï¼‰
- âœ… æ˜¾ç¤ºè¿ç»­ç­¾åˆ°å¤©æ•°
- âœ… ç‚¹å‡»ç”¨æˆ·å¯è·³è½¬åˆ°ç”¨æˆ·ä¸»é¡µ

---

**ç‰ˆæœ¬ï¼š** v4.0.0
**æœ€åæ›´æ–°ï¼š** 2024-12-04
**çŠ¶æ€ï¼š** âœ… Phase 1 å®Œæˆï¼Œâœ… Phase 2 å®Œæˆï¼Œâœ… Phase 3 å®Œæˆï¼Œâœ… Phase 4 å®Œæˆ

## Phase 3 å®Œæˆå†…å®¹ (2025-12-06)

### æ ¸å¿ƒåŠŸèƒ½
1. âœ… **å•†åŸå•†å“ç®¡ç†** - å®Œæ•´çš„ CRUD æ“ä½œ
2. âœ… **å•†å“è´­ä¹°ç³»ç»Ÿ** - æ”¯æŒåº“å­˜ç®¡ç†å’Œé˜²é‡å¤è´­ä¹° (Backend Service Implemented)
3. âœ… **æˆ‘çš„é“å…·ç®¡ç†** - è£…å¤‡/å¸ä¸‹åŠŸèƒ½
4. âœ… **ç®¡ç†åå°** - å•†å“ç®¡ç†é¡µé¢

### åˆ›å»º/ç¡®è®¤çš„æ–‡ä»¶
- `apps/api/src/features/shop/services/shopService.js` - å•†åŸä¸šåŠ¡é€»è¾‘ âœ…
- `apps/api/src/features/shop/routes/index.js` - å•†åŸ API âœ…
- `apps/web/src/features/shop/pages/user/UserShopPage.jsx` - å•†åŸé¡µé¢ âœ…
- `apps/web/src/features/shop/pages/user/UserItemsPage.jsx` - æˆ‘çš„é“å…·é¡µé¢ âœ…
- `apps/web/src/features/shop/pages/admin/AdminShopPage.jsx` - å•†åŸç®¡ç†é¡µé¢ âœ…

---

## Phase 4 å®Œæˆå†…å®¹ (2025-12-06)

### æ ¸å¿ƒåŠŸèƒ½
1. âœ… **ç³»ç»Ÿè®¾ç½®é›†æˆ** - ç§¯åˆ†ç³»ç»Ÿé…ç½® Tab
2. âœ… **ç§¯åˆ†ç®¡ç†é¡µé¢** - ç»Ÿè®¡å±•ç¤ºå’Œæ‰‹åŠ¨æ“ä½œ
3. âœ… **æ‰‹åŠ¨å‘æ”¾/æ‰£é™¤** - æ”¯æŒç”¨æˆ·æœç´¢å’Œè¡¨å•éªŒè¯
4. âœ… **äº¤æ˜“è®°å½•å±•ç¤º** - å®Œæ•´çš„äº¤æ˜“å†å²

### åˆ›å»ºçš„æ–‡ä»¶
- `apps/web/src/app/dashboard/settings/components/CreditSystemSettings.jsx` - é…ç½®ç»„ä»¶
- `apps/web/src/features/credits/pages/admin/AdminCreditsPage.jsx` - ç§¯åˆ†ç®¡ç†é¡µé¢
- `apps/web/src/features/credits/components/admin/*` - ç®¡ç†åå°ç»„ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶
- `apps/web/src/app/dashboard/settings/page.js` - æ·»åŠ ç§¯åˆ†ç³»ç»Ÿ Tab
- `apps/web/src/app/dashboard/credits/page.js` - å¯¼å…¥ AdminCreditsPage
- `apps/web/src/components/forum/DashboardSidebar.jsx` - æ·»åŠ å¯¼èˆªé“¾æ¥

---

## ğŸ‰ ç§¯åˆ†ç³»ç»Ÿå…¨éƒ¨å®Œæˆï¼

æ‰€æœ‰å››ä¸ªé˜¶æ®µå·²å®Œæˆï¼š
- âœ… Phase 1: æ ¸å¿ƒåŸºç¡€ï¼ˆæ•°æ®åº“ã€APIã€åŸºç¡€é¡µé¢ï¼‰
- âœ… Phase 2: ç§¯åˆ†æµé€šï¼ˆè‡ªåŠ¨å¥–åŠ±ã€æ‰“èµã€æ’è¡Œæ¦œï¼‰
- âœ… Phase 3: å•†åŸç³»ç»Ÿï¼ˆå•†å“ç®¡ç†ã€è´­ä¹°ã€é“å…·ï¼‰
- âœ… Phase 4: ç®¡ç†ä¸ä¼˜åŒ–ï¼ˆé…ç½®ã€ç»Ÿè®¡ã€æ‰‹åŠ¨æ“ä½œï¼‰

ç³»ç»Ÿå·²å®Œå…¨å¯ç”¨ï¼Œå¯ä»¥æŠ•å…¥ç”Ÿäº§ç¯å¢ƒï¼

## é™„å½•ï¼šç§¯åˆ†ç³»ç»Ÿæ¨¡å—åŒ–å¯è¡Œæ€§åˆ†æ

ä¸ºäº†æå‡ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§ï¼Œæˆ‘ä»¬å¯¹å°†ç§¯åˆ†ç³»ç»Ÿé‡æ„ä¸ºç‹¬ç«‹å¯æ’æ‹”æ’ä»¶ï¼ˆPluginï¼‰çš„å¯è¡Œæ€§è¿›è¡Œäº†åˆ†æã€‚

### 1. æ€»ä½“æ¶æ„ç›®æ ‡

ç›®æ ‡æ˜¯å°†ç§¯åˆ†ç³»ç»Ÿä»æ ¸å¿ƒä»£ç ä¸­è§£è€¦ï¼Œä½¿å…¶æˆä¸ºä¸€ä¸ªç‹¬ç«‹çš„æ¨¡å—ï¼Œå…·å¤‡ä»¥ä¸‹ç‰¹æ€§ï¼š
- **ç‹¬ç«‹ç›®å½•**ï¼šæ‰€æœ‰åç«¯ä»£ç ï¼ˆSchema, Routes, Servicesï¼‰é›†ä¸­åœ¨ `apps/api/src/plugins/credits`ã€‚
- **ç‹¬ç«‹å‰ç«¯**ï¼šå‰ç«¯ç»„ä»¶å’Œé¡µé¢é›†ä¸­åœ¨ `apps/web/src/features/credits`ï¼ˆæˆ–ç±»ä¼¼ç›®å½•ï¼‰ã€‚
- **æ¾è€¦åˆ**ï¼šæ ¸å¿ƒç³»ç»Ÿé€šè¿‡"äº‹ä»¶"æˆ–"é’©å­"ä¸ç§¯åˆ†ç³»ç»Ÿäº¤äº’ï¼Œè€Œä¸æ˜¯ç›´æ¥è°ƒç”¨ã€‚
- **å¯æ’æ‹”**ï¼šå¯ä»¥é€šè¿‡é…ç½®å¼€å¯/å…³é—­ï¼Œç”šè‡³é€šè¿‡ npm åŒ…çš„å½¢å¼å®‰è£…/å¸è½½ã€‚

### 2. åç«¯æ¨¡å—åŒ–æ–¹æ¡ˆ

#### 2.1 æ•°æ®åº“ Schema è§£è€¦
**ç°çŠ¶**ï¼š
- `schema.js` ä¸­æ··åˆäº†æ ¸å¿ƒè¡¨å’Œç§¯åˆ†è¡¨ã€‚
- `usersRelations` æ˜¾å¼åŒ…å«äº†ç§¯åˆ†ç›¸å…³çš„å…³è”ã€‚

**æ–¹æ¡ˆ**ï¼š
- å°†ç§¯åˆ†ç›¸å…³è¡¨å®šä¹‰ç§»åŠ¨åˆ° `plugins/credits/schema.js`ã€‚
- ä½¿ç”¨ Drizzle çš„å¤šæ–‡ä»¶ Schema åŠŸèƒ½ã€‚
- **éš¾ç‚¹**ï¼š`users` è¡¨çš„ Relations å®šä¹‰ã€‚Drizzle ç›®å‰å€¾å‘äºé›†ä¸­å®šä¹‰ Relationsã€‚
- **è§£å†³**ï¼šä¿æŒ `users` è¡¨åœ¨æ ¸å¿ƒ Schema ä¸­ï¼Œä½†å¯ä»¥é€šè¿‡ä¸€ç§æ³¨å†Œæœºåˆ¶ï¼ˆå¦‚æœ Drizzle æ”¯æŒåŠ¨æ€æ‰©å±• Relationsï¼‰æˆ–è€…æ¥å—åœ¨ `schema.js` ä¸­ä¿ç•™å°‘é‡"èƒ¶æ°´ä»£ç "ï¼ˆå³å¼•å…¥æ’ä»¶ Schema å¹¶åˆå¹¶ï¼‰ã€‚

#### 2.2 ä¸šåŠ¡é€»è¾‘è§£è€¦ï¼ˆEvent Busï¼‰
**ç°çŠ¶**ï¼š
- `topics/index.js` å’Œ `posts/index.js` ç›´æ¥å¯¼å…¥å¹¶è°ƒç”¨ `creditService`ã€‚

**æ–¹æ¡ˆ**ï¼š
- å¼•å…¥äº‹ä»¶æ€»çº¿ï¼ˆEvent Busï¼‰ï¼Œä¾‹å¦‚ `fastify.events` æˆ– Node.js åŸç”Ÿ `EventEmitter`ã€‚
- **æ ¸å¿ƒå±‚**ï¼šåªè´Ÿè´£è§¦å‘äº‹ä»¶ï¼Œä¾‹å¦‚ `emit('topic.created', topic)`ï¼Œä¸å…³å¿ƒæ˜¯å¦æœ‰ç§¯åˆ†ç³»ç»Ÿç›‘å¬ã€‚
- **æ’ä»¶å±‚**ï¼šåœ¨æ’ä»¶åˆå§‹åŒ–æ—¶ç›‘å¬ç›¸å…³äº‹ä»¶ï¼Œä¾‹å¦‚ `on('topic.created', handleTopicReward)`ã€‚
- **ä¼˜åŠ¿**ï¼šæ ¸å¿ƒä»£ç å®Œå…¨ä¸éœ€è¦çŸ¥é“ç§¯åˆ†ç³»ç»Ÿçš„å­˜åœ¨ï¼Œå®ç°äº†çœŸæ­£çš„è§£è€¦ã€‚

#### 2.3 è·¯ç”±ä¸æ’ä»¶æ³¨å†Œ
**ç°çŠ¶**ï¼š
- è·¯ç”±ä½äº `routes/credits`ï¼Œé€šè¿‡ Autoload åŠ è½½ã€‚

**æ–¹æ¡ˆ**ï¼š
- å°†è·¯ç”±ç§»åŠ¨åˆ° `plugins/credits/routes`ã€‚
- åˆ›å»º `plugins/credits/index.js` ä½œä¸ºæ’ä»¶å…¥å£ï¼Œå°è£…è·¯ç”±æ³¨å†Œã€äº‹ä»¶ç›‘å¬åˆå§‹åŒ–ç­‰é€»è¾‘ã€‚
- åœ¨ `app.js` æˆ– `server.js` ä¸­æ˜¾å¼æ³¨å†Œæ’ä»¶ï¼Œæˆ–é…ç½® Autoload æ‰«ææ’ä»¶ç›®å½•ã€‚

### 3. å‰ç«¯æ¨¡å—åŒ–æ–¹æ¡ˆ

#### 3.1 API å®¢æˆ·ç«¯
**ç°çŠ¶**ï¼š
- `lib/api.js` ç¡¬ç¼–ç äº† `creditsApi`ã€‚

**æ–¹æ¡ˆ**ï¼š
- ä¿æŒ `api.js` ä½œä¸ºæ ¸å¿ƒå…¥å£ï¼Œä½†å…è®¸"æ³¨å…¥"æ‰©å±•ã€‚
- æˆ–è€…ï¼Œåœ¨ `features/credits/api.js` ä¸­å®šä¹‰ `creditsApi`ï¼Œåœ¨éœ€è¦çš„åœ°æ–¹å•ç‹¬å¯¼å…¥ï¼Œè€Œä¸æ˜¯æŒ‚è½½åœ¨å…¨å±€ `api` å¯¹è±¡ä¸Šã€‚

#### 3.2 ç»„ä»¶ä¸é¡µé¢
**ç°çŠ¶**ï¼š
- é¡µé¢åˆ†æ•£åœ¨ `app/profile/credits` ç­‰ã€‚
- ç»„ä»¶åˆ†æ•£åœ¨ `components/credits`ã€‚

**æ–¹æ¡ˆ**ï¼š
- é‡‡ç”¨ "Feature-based" ç›®å½•ç»“æ„ï¼Œå°†é¡µé¢ã€ç»„ä»¶ã€APIã€Hooks å…¨éƒ¨ç§»å…¥ `apps/web/src/features/credits`ã€‚
- Next.js çš„ App Router è·¯ç”±ï¼ˆ`app/` ç›®å½•ï¼‰æœ¬è´¨ä¸Šæ˜¯æ–‡ä»¶ç³»ç»Ÿè·¯ç”±ï¼Œéš¾ä»¥å®Œå…¨ç‰©ç†ç§»åŠ¨åˆ° `features/` ç›®å½•ã€‚
- **æŠ˜è¡·**ï¼šä¿æŒ `app/` ç›®å½•ç»“æ„ç”¨äºè·¯ç”±å®šä¹‰ï¼Œä½†é¡µé¢å†…å®¹ï¼ˆPage Contentï¼‰ä½œä¸ºç»„ä»¶ä» `features/credits` å¯¼å…¥ã€‚

#### 3.3 UI é›†æˆç‚¹ï¼ˆæ’æ§½ï¼‰
**ç°çŠ¶**ï¼š
- `ReplyItem.js` ç¡¬ç¼–ç äº† `<RewardDialog>` å’Œæ‰“èµæŒ‰é’®ã€‚

**æ–¹æ¡ˆ**ï¼š
- å¼•å…¥ "Slot" æˆ– "Extension Point" æ¦‚å¿µã€‚
- ä¾‹å¦‚ `TopicFooter` ç»„ä»¶å¯ä»¥æ¥å—ä¸€ä¸ª `actions` æ•°ç»„æˆ–æ¸²æŸ“ `PluginSlots.TopicFooter`ã€‚
- ç§¯åˆ†æ’ä»¶åœ¨åˆå§‹åŒ–æ—¶ï¼ˆæˆ–é€šè¿‡ Contextï¼‰æ³¨å…¥ "RewardButton" åˆ° `TopicFooter` æ’æ§½ä¸­ã€‚
- è¿™æ ·æ ¸å¿ƒç»„ä»¶å°±ä¸éœ€è¦ç¡¬ç¼–ç å…·ä½“çš„æ‰“èµæŒ‰é’®ã€‚

### 4. å®æ–½æ­¥éª¤å»ºè®®

1.  **åç«¯äº‹ä»¶åŒ–**ï¼šé¦–å…ˆå¼•å…¥ Event Busï¼Œå°† `topic.created`, `post.created`, `post.liked` ç­‰å…³é”®åŠ¨ä½œæ”¹ä¸ºäº‹ä»¶è§¦å‘ã€‚
2.  **ç§»åŠ¨åç«¯ä»£ç **ï¼šå»ºç«‹ `plugins/credits` ç›®å½•ï¼Œè¿ç§» Service å’Œ Routesã€‚
3.  **å‰ç«¯ç›®å½•é‡æ„**ï¼šå°è¯• Feature-based ç»“æ„ï¼Œå°†ç§¯åˆ†ç›¸å…³ç»„ä»¶å½’æ‹¢ã€‚
4.  **Schema åˆ†ç¦»**ï¼šå°è¯•å°† Schema å®šä¹‰åˆ†ç¦»ï¼ˆéœ€éªŒè¯ Drizzle çš„æ”¯æŒç¨‹åº¦ï¼‰ã€‚

### 5. ç»“è®º

**å¯è¡Œæ€§**ï¼šé«˜ã€‚
**æ”¶ç›Š**ï¼š
- æ ¸å¿ƒç³»ç»Ÿæ›´åŠ è½»é‡ã€çº¯å‡€ã€‚
- ç§¯åˆ†ç³»ç»Ÿå¯ä»¥ç‹¬ç«‹è¿­ä»£ï¼Œç”šè‡³æ›¿æ¢ä¸ºç¬¬ä¸‰æ–¹æœåŠ¡ã€‚
- ä¸ºæœªæ¥å¼€å‘å…¶ä»–æ’ä»¶ï¼ˆå¦‚ï¼šç­¾åˆ°ã€ä»»åŠ¡ã€å•†åŸï¼‰å»ºç«‹æ ‡å‡†æ¨¡å¼ã€‚

**æ¨è**ï¼šå»ºè®®åœ¨ä¸‹ä¸€é˜¶æ®µï¼ˆç³»ç»Ÿé‡æ„æˆ– V5.0ï¼‰ä¼˜å…ˆå®æ–½åç«¯"äº‹ä»¶åŒ–"æ”¹é€ ï¼Œè¿™æ˜¯è§£è€¦çš„å…³é”®ä¸€æ­¥ã€‚

---

## å‹‹ç« ç³»ç»Ÿ (Phase 3 æ‰©å±•)

å‹‹ç« ç³»ç»Ÿæ˜¯ç§¯åˆ†ä¸æˆå°±ä½“ç³»çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œç”¨äºè¡¨å½°ç”¨æˆ·çš„ç‰¹å®šæˆå°±æˆ–è´¡çŒ®ã€‚

### 1. æ ¸å¿ƒæ¦‚å¿µ
- **å‹‹ç«  (Badge)**: ä¸€ç§å¯è§†åŒ–çš„å¥–åŠ±ï¼Œæ‹¥æœ‰å”¯ä¸€çš„å›¾æ ‡ã€åç§°å’Œæè¿°ã€‚
- **è·å–æ¡ä»¶ (Unlock Condition)**: ç³»ç»Ÿè‡ªåŠ¨åˆ¤æ–­æ˜¯å¦ç»™äºˆå‹‹ç« çš„è§„åˆ™ï¼ˆå¦‚ï¼šå‘å¸–æ•°è¾¾åˆ°100ï¼‰ã€‚
- **è·å–é€”å¾„ (Source)**:
    - `system_rule`: è¾¾æˆæ¡ä»¶è‡ªåŠ¨è·å–
    - `admin_grant`: ç®¡ç†å‘˜æ‰‹åŠ¨é¢å‘
    - `shop_buy`: ç§¯åˆ†å•†åŸè´­ä¹° (ä½œä¸ºå•†å“çš„ä¸€ç§ç±»å‹)
    - `event`: æ´»åŠ¨è·å–

### 2. è‡ªåŠ¨è·å–è§„åˆ™æ”¯æŒ
ç³»ç»Ÿå†…ç½®äº†ä»¥ä¸‹è‡ªåŠ¨åˆ¤æ–­è§„åˆ™ï¼š
- `post_count`: ç´¯è®¡å‘å¸–æ•°
- `topic_count`: ç´¯è®¡è¯é¢˜æ•°
- `like_received_count`: ç´¯è®¡è·å¾—ç‚¹èµæ•°
- `checkin_streak`: è¿ç»­ç­¾åˆ°å¤©æ•°
- `registration_days`: æ³¨å†Œå¤©æ•°

### 3. æ•°æ®ç»“æ„
- `badges`: å®šä¹‰å‹‹ç« å…ƒæ•°æ® (åç§°, å›¾æ ‡, è§„åˆ™)
- `user_badges`: è®°å½•ç”¨æˆ·æ‹¥æœ‰çš„å‹‹ç« åŠè·å–æ—¶é—´

### 4. API ç«¯ç‚¹
```
GET    /api/badges              - è·å–æ‰€æœ‰å¯ç”¨å‹‹ç« 
GET    /api/badges/users/:uid   - è·å–æŒ‡å®šç”¨æˆ·æ‹¥æœ‰çš„å‹‹ç« 
POST   /api/badges/admin        - [Admin] åˆ›å»ºå‹‹ç« 
PATCH  /api/badges/admin/:id    - [Admin] æ›´æ–°å‹‹ç« 
DELETE /api/badges/admin/:id    - [Admin] åˆ é™¤å‹‹ç« 
```

### 5. æ–‡ä»¶ç»“æ„
```
apps/api/src/features/badges/
â”œâ”€â”€ index.js                    âœ… æ’ä»¶å…¥å£
â”œâ”€â”€ schema.js                   âœ… æ•°æ®åº“è¡¨å®šä¹‰
â”œâ”€â”€ services/
â”‚   â””â”€â”€ badgeService.js         âœ… æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ (å«è‡ªåŠ¨è§„åˆ™åˆ¤æ–­)
â””â”€â”€ routes/
    â””â”€â”€ index.js                âœ… API è·¯ç”±
```
```
apps/web/src/features/badges/
â”œâ”€â”€ components/                 âœ… å‰ç«¯ç»„ä»¶ (BadgeList, BadgeIconç­‰)
â”œâ”€â”€ hooks/                      âœ… React Hooks
â””â”€â”€ pages/                      âœ… ç›¸å…³é¡µé¢
```

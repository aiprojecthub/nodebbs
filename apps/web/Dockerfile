# ============================================
# Turborepo Monorepo å¤šé˜¶æ®µæ„å»º - Next.js Web
# ============================================
# æ„å»ºè¯´æ˜ï¼š
# 1. å¿…é¡»ä» monorepo æ ¹ç›®å½•æ„å»º
# 2. ä½¿ç”¨ turbo prune æå–æœ€å°ä¾èµ–é›†
# 3. ä½¿ç”¨ --frozen-lockfile ç¡®ä¿æ„å»ºå¯é‡å¤æ€§
# 4. æ”¯æŒ Next.js æ„å»ºæ—¶ç¯å¢ƒå˜é‡æ³¨å…¥
# ============================================

FROM node:20-alpine AS base
RUN corepack enable && corepack prepare pnpm@10.21.0 --activate

# ============================================
# é˜¶æ®µ 1: ä½¿ç”¨ turbo prune æå–ä¾èµ–
# ============================================
FROM base AS pruner
WORKDIR /app

# å¤åˆ¶æ•´ä¸ª monorepoï¼ˆturbo prune éœ€è¦å®Œæ•´çš„ workspace ä¿¡æ¯ï¼‰
COPY . .

# æå– nodebbs-web åº”ç”¨åŠå…¶ä¾èµ–çš„æœ€å°å­é›†
# --docker é€‰é¡¹ä¼šç”Ÿæˆä¸¤ä¸ªè¾“å‡ºç›®å½•ï¼š
#   - out/json: ä»…åŒ…å« package.json æ–‡ä»¶ï¼ˆç”¨äº Docker å±‚ç¼“å­˜ä¼˜åŒ–ï¼‰
#   - out/full: åŒ…å«å®Œæ•´çš„æºä»£ç å’Œä¾èµ–
# æ³¨æ„ï¼šä½¿ç”¨ package.json ä¸­çš„ "name" å­—æ®µå€¼ï¼Œä¸æ˜¯ç›®å½•å
RUN pnpm dlx turbo prune nodebbs-web --docker

# ============================================
# é˜¶æ®µ 2: å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆæ„å»ºæ—¶éœ€è¦ï¼‰
# ============================================
FROM base AS deps
WORKDIR /app

# å¤åˆ¶ prune é˜¶æ®µç”Ÿæˆçš„ package.json æ–‡ä»¶
# è¿™ä¸€å±‚ä¼šè¢« Docker ç¼“å­˜ï¼Œé™¤éä¾èµ–å‘ç”Ÿå˜åŒ–
COPY --from=pruner /app/out/json/ .

# å¤åˆ¶ lockfile å’Œ workspace é…ç½®
COPY --from=pruner /app/out/pnpm-lock.yaml ./pnpm-lock.yaml
COPY --from=pruner /app/out/pnpm-workspace.yaml ./pnpm-workspace.yaml

# å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬ devDependenciesï¼Œæ„å»ºæ—¶éœ€è¦ï¼‰
# ä½¿ç”¨ --frozen-lockfile ç¡®ä¿æ„å»ºå¯é‡å¤æ€§
# pnpm ä¼šè‡ªåŠ¨å¤„ç† workspace ä¾èµ–ï¼Œåœ¨æ ¹ç›®å½•å’Œå„ä¸ªåŒ…ä¸­åˆ›å»º node_modules
RUN --mount=type=cache,id=pnpm,target=/root/.pnpm-store \
    pnpm install --frozen-lockfile --prefer-offline

# ============================================
# é˜¶æ®µ 3: æ„å»º Next.js åº”ç”¨
# ============================================
FROM base AS builder
WORKDIR /app

# å£°æ˜æ„å»ºå‚æ•°ï¼ˆæ¥è‡ª docker-compose build argsï¼‰
ARG NEXT_PUBLIC_API_URL
ARG NEXT_PUBLIC_APP_URL

# å¯¼å…¥ä¸ºç¯å¢ƒå˜é‡ä¾› Next.js æ„å»ºæ—¶ä½¿ç”¨
ENV NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
ENV NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL}
ENV NEXT_TELEMETRY_DISABLED=1

# å…ˆå¤åˆ¶å·²å®‰è£…ä¾èµ–çš„ç›®å½•ç»“æ„ï¼ˆåŒ…æ‹¬æ‰€æœ‰ node_modulesï¼‰
COPY --from=deps /app/ ./

# å†å¤åˆ¶ prune çš„å®Œæ•´æºä»£ç ï¼ˆä¼šè¦†ç›–ä¸Šé¢çš„æºæ–‡ä»¶ï¼Œä½†ä¿ç•™ node_modulesï¼‰
COPY --from=pruner /app/out/full/ ./

# æ„å»ºåº”ç”¨ï¼ˆä½¿ç”¨ turbo åœ¨æ ¹ç›®å½•æ„å»ºï¼‰
# Next.js ä¼šç”Ÿæˆ standalone è¾“å‡ºåˆ° apps/web/.next
RUN echo "ğŸš§ Building Next.js with NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}" && \
    pnpm turbo build --filter=nodebbs-web

# ============================================
# é˜¶æ®µ 4: ç”Ÿäº§ç¯å¢ƒè¿è¡Œæ—¶ï¼ˆä»…åŒ…å«è¿è¡Œæ—¶æ–‡ä»¶ï¼‰
# ============================================
FROM base AS runner
WORKDIR /app

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1
ENV PORT=3100

# åˆ›å»ºé root ç”¨æˆ·ï¼ˆå®‰å…¨æœ€ä½³å®è·µï¼‰
RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 nextjs

# å¤åˆ¶ Next.js standalone è¾“å‡º
# standalone æ¨¡å¼ä¼šè‡ªåŠ¨åŒ…å«æ‰€æœ‰å¿…éœ€çš„è¿è¡Œæ—¶ä¾èµ–
COPY --from=builder --chown=nextjs:nodejs /app/apps/web/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/apps/web/.next/static ./apps/web/.next/static

# å¤åˆ¶ public é™æ€æ–‡ä»¶åˆ° standalone æœŸæœ›çš„ä½ç½®
# Next.js standalone çš„ server.js ä¼šåœ¨ apps/web/public æŸ¥æ‰¾é™æ€æ–‡ä»¶
COPY --from=builder --chown=nextjs:nodejs /app/apps/web/public ./apps/web/public

# åˆ‡æ¢åˆ°é root ç”¨æˆ·
USER nextjs

# æš´éœ²ç«¯å£
EXPOSE 3100

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=10s --retries=3 \
  CMD node -e "require('http').get('http://localhost:3100', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"

# å¯åŠ¨å‘½ä»¤ï¼ˆstandalone æ¨¡å¼ä¼šç”Ÿæˆ server.jsï¼‰
CMD ["node", "apps/web/server.js"]
